# MONTAMOS IMAGEN.
FROM debian:bullseye

# SELECCIONAMOS LOS "ARGUMENTOS DE CONSTRUCCION", QIE SERVIRAN PARA INICIALIZAR LAS VARIABLES DE ENTORNO.
ARG MDB_NAME
ARG MDB_USER
ARG MDB_USER_PASS
ARG MDB_ROOT_PASS

ENV MDB_NAME=$MDB_NAME \
    MDB_USER=$MDB_USER \
    MDB_USER_PASS=$MDB_USER_PASS \
    MDB_ROOT_PASS=$MDB_ROOT_PASS

# EJECUTAMOS DE COMANDOS: INSTALAMOS TODO Y PARA BORRAR BASURA (EN CASO DE LOS MAC DEL CAMPUS VA FETÉ XD).
RUN apt-get update && apt upgrade -y && \
    apt-get install -y mariadb-server && \
    apt-get clean && rm -rf /var/lib/apt/lists/* /tmp/* /var/tmp/*

# COPIAMOS NUESTRO ARCHIVO DE CONFIGURACION PERSONALIZADO A LA RAIZ DEL CONTENEDOR (LA PONEMOS EN "MY.CNF").
COPY ./my.cnf /etc/mysql/my.cnf

# EJECUCION DE COMANDOS: CREAMOS DIRECTORIO PARA MARIADB Y CAMBIAMOS EL PROPIETARIO PARA QUE MYSQL TENGA PERMISOS EN MARIADB.
RUN mkdir -p /var/run/mysqld/
RUN chown -R mysql:mysql /var/run/mysqld/

# EXPONEMOS EL PUERTO ESTANDAR DE MARIADB.
EXPOSE 3306

# EJECUCION DE COMANDOS:
# - INICIAMOS MARIADB
# - CREAMOS EL FICHERO SQL SI NO EXISTE.
# - CREAMOS EL USUARIO Y CONTRASEÑA SI NO EXISTE.
# - ASIGNAMOS PERMISOS AL USUARIO.
# - ASIGNAMOS PERMISOS DEL USUARIO SOBRE LA BASE DE DATOS.
# - CAMBIAMOS LA CONTRASEÑA DE ROOT POR LA QUE TENEMOS EN EN .ENV.
# - APLICAMOS LOS CAMBIOS EJECUTANDO EL ARCHIVO "MSQL_DB.SQL".
RUN service mariadb start && \
    echo "CREATE DATABASE IF NOT EXISTS ${DB_NAME} ;" > msql_db.sql && \
    echo "CREATE USER IF NOT EXISTS '${DB_USER}'@'%' IDENTIFIED BY '${DB_PASS}' ;" >> msql_db.sql && \
    echo "GRANT ALL PRIVILEGES ON ${DB_NAME}.* TO '${DB_USER}'@'%' ;" >> msql_db.sql && \
    echo "FLUSH PRIVILEGES;" >> msql_db.sql && \
    echo "ALTER USER 'root'@'localhost' IDENTIFIED BY '${DB_ROOT_PASS}' ;" >> msql_db.sql && mariadb < msql_db.sql

# DEFINIMOS EL COMANDO PARA INICIAR MARIADB.
CMD ["mysqld"]